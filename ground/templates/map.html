{% extends "base.html" %}
{% block title %}Map - RaptorHab Ground Station{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #map-container {
        position: relative;
    }
    #map {
        height: calc(100vh - 200px);
        min-height: 500px;
    }
    .map-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        min-width: 200px;
    }
    .map-controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 1000;
    }
    .prediction-line {
        stroke-dasharray: 5, 10;
    }
    .altitude-profile {
        height: 150px;
        background: #fff;
        border-radius: 8px;
        padding: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-map-fill text-primary"></i> Flight Track
                </h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="centerOnPayload()">
                        <i class="bi bi-crosshair"></i> Center
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="fitTrack()">
                        <i class="bi bi-arrows-fullscreen"></i> Fit Track
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-layers"></i> Layers
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="setMapLayer('osm')">OpenStreetMap</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setMapLayer('satellite')">Satellite</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setMapLayer('terrain')">Terrain</a></li>
                        </ul>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/api/export/kml">Download KML</a></li>
                            <li><a class="dropdown-item" href="/api/export/csv">Download CSV</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-0" id="map-container">
                <div id="map"></div>
                
                <!-- Info Overlay -->
                <div class="map-overlay">
                    <h6 class="mb-2"><i class="bi bi-balloon-fill text-danger"></i> Payload</h6>
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Lat:</td>
                            <td id="overlay-lat">--</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Lon:</td>
                            <td id="overlay-lon">--</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Alt:</td>
                            <td><span id="overlay-alt">--</span> m</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Speed:</td>
                            <td><span id="overlay-speed">--</span> m/s</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Heading:</td>
                            <td><span id="overlay-heading">--</span>°</td>
                        </tr>
                    </table>
                    <hr class="my-2">
                    <h6 class="mb-2"><i class="bi bi-compass-fill text-info"></i> Tracking</h6>
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted">Distance:</td>
                            <td><span id="overlay-distance">--</span> km</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Bearing:</td>
                            <td><span id="overlay-bearing">--</span>° (<span id="overlay-compass">--</span>)</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Elevation:</td>
                            <td><span id="overlay-elevation">--</span>°</td>
                        </tr>
                    </table>
                    <hr class="my-2">
                    <small class="text-muted">
                        Track points: <span id="track-points">0</span><br>
                        Track distance: <span id="track-distance">0</span> km
                    </small>
                </div>
                
                <!-- Map Controls -->
                <div class="map-controls">
                    <div class="btn-group-vertical">
                        <button class="btn btn-light btn-sm" onclick="toggleTrack()" title="Toggle track visibility">
                            <i class="bi bi-bezier2"></i>
                        </button>
                        <button class="btn btn-light btn-sm" onclick="togglePrediction()" title="Toggle landing prediction">
                            <i class="bi bi-bullseye"></i>
                        </button>
                        <button class="btn btn-light btn-sm" onclick="clearTrack()" title="Clear track">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Altitude Profile -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Altitude Profile</h6>
            </div>
            <div class="card-body">
                <canvas id="altitude-chart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Map setup
    const map = L.map('map').setView([{{ config.map_default_lat }}, {{ config.map_default_lon }}], {{ config.map_default_zoom }});
    
    // Tile layers
    const layers = {
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        }),
        terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenTopoMap'
        })
    };
    
    layers.osm.addTo(map);
    let currentLayer = 'osm';
    
    function setMapLayer(layerName) {
        map.removeLayer(layers[currentLayer]);
        layers[layerName].addTo(map);
        currentLayer = layerName;
    }
    
    // Payload marker with custom icon
    const payloadIcon = L.divIcon({
        html: '<i class="bi bi-balloon-fill" style="font-size: 24px; color: #dc3545;"></i>',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        className: 'payload-marker'
    });
    
    // Ground station marker icon
    const groundIcon = L.divIcon({
        html: '<i class="bi bi-house-fill" style="font-size: 24px; color: #28a745;"></i>',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        className: 'ground-marker'
    });
    
    let marker = null;
    let groundMarker = null;
    let groundToPayloadLine = null;
    let track = L.polyline([], {color: '#dc3545', weight: 3}).addTo(map);
    let predictionLine = null;
    let trackPoints = [];
    let trackVisible = true;
    let predictionVisible = false;
    let altitudeData = [];
    let timeData = [];
    
    // Altitude chart
    const altCtx = document.getElementById('altitude-chart').getContext('2d');
    const altitudeChart = new Chart(altCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Altitude (m)',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    display: true,
                    title: { display: true, text: 'Time' }
                },
                y: {
                    display: true,
                    title: { display: true, text: 'Altitude (m)' },
                    beginAtZero: true
                }
            }
        }
    });
    
    // Update from telemetry
    socket.on('telemetry', function(data) {
        // Update overlay
        document.getElementById('overlay-lat').textContent = data.latitude ? data.latitude.toFixed(6) : '--';
        document.getElementById('overlay-lon').textContent = data.longitude ? data.longitude.toFixed(6) : '--';
        document.getElementById('overlay-alt').textContent = data.altitude ? data.altitude.toFixed(0) : '--';
        document.getElementById('overlay-speed').textContent = data.speed ? data.speed.toFixed(1) : '--';
        document.getElementById('overlay-heading').textContent = data.heading ? data.heading.toFixed(0) : '--';
        
        // Update map
        if (data.latitude && data.longitude && data.latitude !== 0) {
            const pos = [data.latitude, data.longitude];
            
            if (!marker) {
                marker = L.marker(pos, {icon: payloadIcon}).addTo(map);
                marker.bindPopup(createPopupContent(data));
                map.setView(pos, 12);
            } else {
                marker.setLatLng(pos);
                marker.setPopupContent(createPopupContent(data));
            }
            
            // Add to track
            trackPoints.push(pos);
            if (trackVisible) {
                track.setLatLngs(trackPoints);
            }
            
            // Update track stats
            document.getElementById('track-points').textContent = trackPoints.length;
            document.getElementById('track-distance').textContent = calculateDistance().toFixed(2);
            
            // Update altitude chart
            const time = new Date(data.received_at * 1000).toLocaleTimeString();
            altitudeData.push(data.altitude);
            timeData.push(time);
            
            // Keep last 100 points
            if (altitudeData.length > 100) {
                altitudeData.shift();
                timeData.shift();
            }
            
            altitudeChart.data.labels = timeData;
            altitudeChart.data.datasets[0].data = altitudeData;
            altitudeChart.update('none');
            
            // Update ground-to-payload line if ground marker exists
            if (groundMarker && marker) {
                const groundPos = groundMarker.getLatLng();
                const payloadPos = marker.getLatLng();
                if (groundToPayloadLine) {
                    groundToPayloadLine.setLatLngs([[groundPos.lat, groundPos.lng], [payloadPos.lat, payloadPos.lng]]);
                } else {
                    groundToPayloadLine = L.polyline([[groundPos.lat, groundPos.lng], [payloadPos.lat, payloadPos.lng]], {
                        color: '#17a2b8',
                        weight: 2,
                        dashArray: '5, 10',
                        opacity: 0.7
                    }).addTo(map);
                }
            }
        }
    });
    
    function createPopupContent(data) {
        return `
            <strong>Payload Position</strong><br>
            Lat: ${data.latitude.toFixed(6)}<br>
            Lon: ${data.longitude.toFixed(6)}<br>
            Alt: ${data.altitude.toFixed(0)} m<br>
            Speed: ${data.speed.toFixed(1)} m/s<br>
            Sats: ${data.satellites}
        `;
    }
    
    function calculateDistance() {
        let total = 0;
        for (let i = 1; i < trackPoints.length; i++) {
            total += map.distance(trackPoints[i-1], trackPoints[i]);
        }
        return total / 1000; // Convert to km
    }
    
    function centerOnPayload() {
        if (marker) {
            map.setView(marker.getLatLng(), map.getZoom());
        }
    }
    
    function fitTrack() {
        if (trackPoints.length > 0) {
            map.fitBounds(track.getBounds(), {padding: [50, 50]});
        }
    }
    
    function toggleTrack() {
        trackVisible = !trackVisible;
        if (trackVisible) {
            track.addTo(map);
        } else {
            track.remove();
        }
    }
    
    function togglePrediction() {
        predictionVisible = !predictionVisible;
        
        if (!predictionVisible) {
            if (predictionLine) {
                predictionLine.remove();
                predictionLine = null;
            }
            if (window.landingMarker) {
                window.landingMarker.remove();
                window.landingMarker = null;
            }
            return;
        }
        
        // Simple landing prediction based on current state
        // This extrapolates current drift to estimate landing
        if (!marker || trackPoints.length < 10) {
            alert('Need more track data for prediction');
            predictionVisible = false;
            return;
        }
        
        // Get recent movement to estimate drift
        const recent = trackPoints.slice(-10);
        const firstPt = recent[0];
        const lastPt = recent[recent.length - 1];
        
        // Calculate drift rate (degrees per point)
        const latDrift = (lastPt[0] - firstPt[0]) / recent.length;
        const lonDrift = (lastPt[1] - firstPt[1]) / recent.length;
        
        // Estimate descent rate from altitude data
        const recentAlt = altitudeData.slice(-10);
        const altDrop = recentAlt[0] - recentAlt[recentAlt.length - 1];
        const avgDescentPerPoint = altDrop / recentAlt.length;
        
        if (avgDescentPerPoint <= 0) {
            alert('Balloon appears to be ascending - no landing prediction available');
            predictionVisible = false;
            return;
        }
        
        // Calculate points to landing
        const currentAlt = recentAlt[recentAlt.length - 1];
        const pointsToLanding = Math.ceil(currentAlt / avgDescentPerPoint);
        
        // Limit prediction to reasonable range
        const maxPoints = Math.min(pointsToLanding, 500);
        
        // Generate prediction path
        const predictionPath = [lastPt];
        let lat = lastPt[0];
        let lon = lastPt[1];
        
        for (let i = 0; i < maxPoints; i++) {
            lat += latDrift;
            lon += lonDrift;
            predictionPath.push([lat, lon]);
        }
        
        // Draw prediction line (dashed)
        predictionLine = L.polyline(predictionPath, {
            color: '#ffc107',
            weight: 2,
            dashArray: '10, 10',
            opacity: 0.7
        }).addTo(map);
        
        // Add landing marker
        const landingPt = predictionPath[predictionPath.length - 1];
        window.landingMarker = L.marker(landingPt, {
            icon: L.divIcon({
                html: '<i class="bi bi-geo-alt-fill" style="font-size: 24px; color: #ffc107;"></i>',
                iconSize: [24, 24],
                iconAnchor: [12, 24],
                className: 'landing-marker'
            })
        }).addTo(map);
        
        // Calculate distance to landing
        const distKm = map.distance(lastPt, landingPt) / 1000;
        window.landingMarker.bindPopup(
            `<strong>Estimated Landing</strong><br>` +
            `Lat: ${landingPt[0].toFixed(6)}<br>` +
            `Lon: ${landingPt[1].toFixed(6)}<br>` +
            `Distance: ${distKm.toFixed(1)} km<br>` +
            `<em>Based on current drift</em>`
        ).openPopup();
    }
    
    function clearTrack() {
        if (confirm('Clear all track points?')) {
            trackPoints = [];
            track.setLatLngs([]);
            altitudeData = [];
            timeData = [];
            altitudeChart.data.labels = [];
            altitudeChart.data.datasets[0].data = [];
            altitudeChart.update();
        }
    }
    
    // Update tracking info (distance/bearing to payload)
    function updateTracking(data) {
        document.getElementById('overlay-distance').textContent = data.distance_km ? data.distance_km.toFixed(2) : '--';
        document.getElementById('overlay-bearing').textContent = data.bearing_deg ? data.bearing_deg.toFixed(0) : '--';
        document.getElementById('overlay-compass').textContent = data.bearing_deg ? bearingToCompass(data.bearing_deg) : '--';
        document.getElementById('overlay-elevation').textContent = data.elevation_deg ? data.elevation_deg.toFixed(1) : '--';
        
        // Update ground station marker
        if (data.ground_lat && data.ground_lon) {
            const groundPos = [data.ground_lat, data.ground_lon];
            
            if (!groundMarker) {
                groundMarker = L.marker(groundPos, {icon: groundIcon}).addTo(map);
                groundMarker.bindPopup('<strong>Ground Station</strong><br>Your location');
            } else {
                groundMarker.setLatLng(groundPos);
            }
            
            // Draw line from ground to payload
            if (marker) {
                const payloadPos = marker.getLatLng();
                if (groundToPayloadLine) {
                    groundToPayloadLine.setLatLngs([groundPos, [payloadPos.lat, payloadPos.lng]]);
                } else {
                    groundToPayloadLine = L.polyline([groundPos, [payloadPos.lat, payloadPos.lng]], {
                        color: '#17a2b8',
                        weight: 2,
                        dashArray: '5, 10',
                        opacity: 0.7
                    }).addTo(map);
                }
            }
        }
    }
    
    function bearingToCompass(bearing) {
        const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                           'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        const index = Math.round(bearing / 22.5) % 16;
        return directions[index];
    }
    
    // Fetch tracking info periodically
    setInterval(function() {
        fetch('/api/tracking')
            .then(r => r.json())
            .then(data => {
                if (!data.error) {
                    updateTracking(data);
                }
            })
            .catch(() => {});
    }, 2000);
    
    // Load existing track on page load
    fetch('/api/telemetry/track?interval=2&session=current')
        .then(r => r.json())
        .then(data => {
            trackPoints = data.map(p => [p.lat, p.lon]);
            track.setLatLngs(trackPoints);
            
            // Load altitude data
            altitudeData = data.map(p => p.alt);
            timeData = data.map(p => new Date(p.time * 1000).toLocaleTimeString());
            
            // Limit to last 100
            if (altitudeData.length > 100) {
                altitudeData = altitudeData.slice(-100);
                timeData = timeData.slice(-100);
            }
            
            altitudeChart.data.labels = timeData;
            altitudeChart.data.datasets[0].data = altitudeData;
            altitudeChart.update();
            
            if (trackPoints.length > 0) {
                map.fitBounds(track.getBounds(), {padding: [50, 50]});
                
                // Place marker at last point
                const lastPos = trackPoints[trackPoints.length - 1];
                marker = L.marker(lastPos, {icon: payloadIcon}).addTo(map);
            }
            
            document.getElementById('track-points').textContent = trackPoints.length;
            document.getElementById('track-distance').textContent = calculateDistance().toFixed(2);
        });
    
    // Load initial tracking info
    fetch('/api/tracking')
        .then(r => r.json())
        .then(data => {
            if (!data.error) {
                updateTracking(data);
            }
        })
        .catch(() => {});
</script>
{% endblock %}
